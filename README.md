# LightHsu-ALS-Communicator

## 1. 简介

帮助行动不便用户（如 ALS 患者、高位截瘫患者）用简单的面部动作与看护者进行沟通交流。

## 2. 软硬件要求

### 2.1 硬件要求

* **计算机**：运行 Windows 10及以上系统的电脑。
* **摄像头**：普通的 USB 摄像头或笔记本自带摄像头（建议分辨率不低于1080p以保证识别精度）。
* **扬声器**：用于文字转语音（TTS）播放和紧急报警。

### 2.2 软件要求

测试通过的版本参考：

* Python          : 3.12.10
* numpy           : 2.4.1
* opencv-python   : 4.13.0
* mediapipe       : 0.10.32
* keyboard        : 0.13.5
* pyttsx3         : 2.99
* Pillow          : 12.0.0
* pyautogui       : 0.9.54
* pygame          : 2.6.1

#### 注意：确保下载了 `face_landmarker.task` 文件并将其放在主程序同级目录下。

## 3. 文件结构说明

* `LightMouseCTRLMENU.py`: 主程序代码。
* `EditorMENU.py`: 可视化的参数调整与菜单编辑工具。
* `face_landmarker.task`: **(必须手动下载)** Google MediaPipe 的面部特征模型文件。
* `configMENU.ini`: 参数配置文件（灵敏度、时间阈值等）。
* `menuData.dat`: 菜单内容数据文件（JSON格式，可自定义菜单项）。
* `001.mp3`: **(必须存在)** 紧急呼叫时播放的警报音频文件。
* `simhei.ttf`: (可选) 界面中文字体文件，若无则使用默认。
* `myTypeText.txt`: 文字输入窗口自动保存的文本内容。
* `textSnd.txt`: 朗读 txt 功能读取的示例文件。

## 4. 启动与校准

1. **启动程序**：运行 `LightMouseCTRLMENU.py` 主程序。
2. **选择摄像头**：
   * 控制台会列出可用摄像头 ID。
   * 如果只有一个摄像头，会自动进入；如果有多个，输入对应数字 ID 并回车。
3. **面部校准**：
   * 屏幕会出现一个视频窗口，显示绿色的面部框。
   * 保持头部姿态自然（中立位置），不要闭眼。
   * 当系统检测到稳定的张嘴动作后，校准完成，进入菜单界面。

## 5. 操作控制说明

### 5.1 基本导航

* **向下移动光标**：
  * **动作**：眨眼。
  * **或** 头部向下点（需在配置中开启头部控制模式）。
* **确认 / 进入子菜单 / 触发功能**：
  * **动作**：张嘴。
  * **或** 头部向右转。
* **返回上一级菜单**：
  * **动作**：闭眼时长 **1.0 ~ 2.0 秒**。
  * **或** 头部向左转。
* **返回主菜单（根目录）**：
  * **动作**：闭眼时长 **2.0 ~ 10.0 秒**。

### 5.2 紧急呼叫模式

* **触发方式**：
    * **长时间闭眼**：超过 10 秒。
    * **长时间张嘴**：超过 6 秒。
    * **人脸丢失**：人脸离开画面超过 6 秒。
* **系统反应**：
    * 屏幕显示红色全屏警告。
    * 循环播放 `001.mp3` 警报声。
    * 自动将系统音量调至最大。
* **解除报警**：
    * 用户需再次**张嘴**，然后**闭嘴**即可恢复正常。
    * 或键盘按 `ESC` 退出程序。

### 5.3 文字输入模式（虚拟键盘）

菜单选择“打开文字窗口”进入此模式。

* **输入法逻辑**：采用行列扫描法。
  * **当前行高亮** => **眨眼**切换下一行 => **张嘴**选中该行。
  * **行内字符高亮** => **眨眼**切换字符 => **张嘴**输入该字符。
* **特殊按键**：
* `上一页`、`下一页`、`切换`：控制中/英文输入法选词。
* `退出`：保存文本并返回主菜单。
* `空格`、`退格`、`回车`：对应键盘功能。
* **自动保存**：内容每 5 分钟自动保存到 `myTypeText.txt`。

### 5.4 网页浏览模式

菜单选择包含网址（如 `http://...`）进入此模式。

* **自动操作**：程序会打开浏览器并尝试全屏。
* **控制方式**：
  * **鼠标左键点击**：短张嘴。
  * **向下滚动**：闭眼时长 1.0 ~ 2.0 秒。
  * **关闭浏览器并返回菜单界面**：闭眼时长 2.0 ~ 10.0 秒。

## 6. 菜单配置

`menuData.dat` 文件用于自定义菜单。

* **普通菜单**：`"父级名称": "子项1\n子项2\n子项3"`
* **语音播报**：菜单项前加 `！` 或 `★`，选中后会直接朗读该文本，不进入子菜单。
* **打开网站**：菜单项名称中包含网址，或格式为 `★网站名（https://...）`。
* **朗读文件**：如果菜单项包含 `.txt` 文件名（如 `textSnd.txt`），系统会读取该文件内容并朗读。

## 7. 参数调整

`configMENU.ini` 文件用于可调整参数。如：

* **[Thresholds] (阈值)**
    * `BlinkThreshold`: 眼睛闭合判定阈值（越小越灵敏，默认 0.3）。
    * `MouthTrigger`: 嘴巴张开判定阈值（默认 0.4）。
* **[Timers] (时间/秒)**
    * `CloseBack`: 闭眼多少秒触发“返回”（默认 1.0）。
    * `CloseTop`: 闭眼多少秒触发“回主页”（默认 2.0）。
    * `CloseEmergency`: 闭眼多少秒触发“报警”（默认 10.0）。
    * `FaceMissingEmergency`: 人脸消失多少秒触发“报警”（默认 6.0）。
* **[Head] (头部控制)**
    * `HeadRangeX/Y`: 头部运动范围归一化系数。
    * `HeadTiltThresX/Y`: 触发头部动作的倾斜阈值。

## 8.  可视化配置工具

可视化的参数调整与菜单编辑工具，用户可以：

* **调整参数**：通过滑块直观地调整眨眼、张嘴、头部动作的触发阈值和冷却时间等。
* **自定义菜单**：添加、修改或删除主程序中的菜单项、语音指令和网页链接。
* **数据备份**：支持菜单数据的备份与导入，防止误操作导致数据丢失。

#### 注意：必须与主程序 (`LightMouseCTRLMENU.py`) 放在同一目录下。

## 9. 本项目使用到的其他开源项目

[PyStand](https://github.com/skywind3000/PyStand)  

用于将 Python 程序打包为单文件可执行程序 / 便携运行环境。

